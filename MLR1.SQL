# -----------------------------------------------------------------------------
#       TABLE : POSSEDER
# -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS POSSEDER
 (
   IDRES CHAR(32) NOT NULL  ,
   CODE_BARRE CHAR(32) NULL  
 ) 
 comment = "";

ALTER TABLE POSSEDER
ADD
 PRIMARY KEY (IDRES) ;

# -----------------------------------------------------------------------------
#       TABLE : EXEMPLAIRE
# -----------------------------------------------------------------------------

ALTER TABLE EXEMPLAIRE
DROP COLUMN 
  IDRES;

ALTER TABLE EXEMPLAIRE
DROP COLUMN 
  DATEDERETOUR;

ALTER TABLE EXEMPLAIRE
DROP COLUMN 
  DATEDEPRET;

DROP INDEX I_FK_EXEMPLAIRE_RESSOURCE
     ON EXEMPLAIRE;

ALTER TABLE ENREGISTRE
   DROP FOREIGN KEY FK_ENREGISTRE_UTILISATEUR;

ALTER TABLE RENDRE
   DROP FOREIGN KEY FK_RENDRE_UTILISATEUR;

ALTER TABLE EMPRUNTER
   DROP FOREIGN KEY FK_EMPRUNTER_UTILISATEUR;

ALTER TABLE PARTICULIER
   DROP FOREIGN KEY FK_PARTICULIER_UTILISATEUR;

ALTER TABLE ETUDIANT
   DROP FOREIGN KEY FK_ETUDIANT_UTILISATEUR;

# -----------------------------------------------------------------------------
#       TABLE : tmp_UTILISATEUR
# -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS tmp_UTILISATEUR
 (
   NOM CHAR(32) NULL  ,
   CAUTION CHAR(32) NULL  ,
   IDUTILISATEUR REAL(5,2) NOT NULL  ,
   PRENOM CHAR(32) NULL  ,
   EMAIL CHAR(32) NULL  ,
   TELEPHONE CHAR(32) NULL  ,
   PASSWORD CHAR(32) NULL  ,
   PHOTO CHAR(32) NULL  
 ) 
 comment = "";


INSERT INTO tmp_UTILISATEUR (NOM,CAUTION,IDUTILISATEUR,PRENOM,EMAIL,TELEPHONE,PASSWORD,PHOTO)
SELECT NOM,CAUTION,IDUTILISATEUR,PRENOM,EMAIL,TELEPHONE,PASSWORD,PHOTO
FROM UTILISATEUR;

DROP TABLE IF EXISTS UTILISATEUR;


RENAME tmp_UTILISATEUR TO UTILISATEUR;
ALTER TABLE UTILISATEUR
ADD
 PRIMARY KEY (IDUTILISATEUR) ;

# -----------------------------------------------------------------------------
#       TABLE : tmp_ETUDIANT
# -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS tmp_ETUDIANT
 (
   IDUTILISATEUR REAL(5,2) NOT NULL  ,
   ETABLISSEMENT CHAR(32) NULL  ,
   DATEDENAISSANCE CHAR(32) NULL  ,
   IDCARTEETUDIANT CHAR(32) NULL  ,
   ANNEEETUDE CHAR(32) NULL  
 ) 
 comment = "";


INSERT INTO tmp_ETUDIANT (IDUTILISATEUR,ETABLISSEMENT,DATEDENAISSANCE,IDCARTEETUDIANT,ANNEEETUDE)
SELECT IDUTILISATEUR,ETABLISSEMENT,DATEDENAISSANCE,IDCARTEETUDIANT,ANNEEETUDE
FROM ETUDIANT;

DROP TABLE IF EXISTS ETUDIANT;


RENAME tmp_ETUDIANT TO ETUDIANT;
ALTER TABLE ETUDIANT
ADD
 PRIMARY KEY (IDUTILISATEUR) ;

DROP INDEX I_FK_RESSOURCE_EMPLACEMENT
     ON RESSOURCE;

CREATE UNIQUE INDEX I_FK_RESSOURCE_EMPLACEMENT
     ON RESSOURCE (ZONE ASC);

# -----------------------------------------------------------------------------
#       TABLE : tmp_PARTICULIER
# -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS tmp_PARTICULIER
 (
   IDUTILISATEUR REAL(5,2) NOT NULL  ,
   NISS CHAR(32) NULL  
 ) 
 comment = "";


INSERT INTO tmp_PARTICULIER (IDUTILISATEUR,NISS)
SELECT IDUTILISATEUR,NISS
FROM PARTICULIER;

DROP TABLE IF EXISTS PARTICULIER;


RENAME tmp_PARTICULIER TO PARTICULIER;
ALTER TABLE PARTICULIER
ADD
 PRIMARY KEY (IDUTILISATEUR) ;

ALTER TABLE ENREGISTRE
   DROP FOREIGN KEY FK_ENREGISTRE_BIBLIOTHECAIRE;

# -----------------------------------------------------------------------------
#       TABLE : tmp_ENREGISTRE
# -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS tmp_ENREGISTRE
 (
   IDUTILISATEUR REAL(5,2) NOT NULL  ,
   CODE CHAR(32) NOT NULL  
 ) 
 comment = "";


INSERT INTO tmp_ENREGISTRE (IDUTILISATEUR,CODE)
SELECT IDUTILISATEUR,CODE
FROM ENREGISTRE;

DROP TABLE IF EXISTS ENREGISTRE;


RENAME tmp_ENREGISTRE TO ENREGISTRE;
ALTER TABLE ENREGISTRE
ADD
 PRIMARY KEY (IDUTILISATEUR,CODE) ;

ALTER TABLE RENDRE
   DROP FOREIGN KEY FK_RENDRE_EXEMPLAIRE;

# -----------------------------------------------------------------------------
#       TABLE : tmp_RENDRE
# -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS tmp_RENDRE
 (
   CODE_BARRE CHAR(32) NOT NULL  ,
   IDUTILISATEUR REAL(5,2) NULL  ,
   DATE_RETOUR CHAR(32) NULL  
 ) 
 comment = "";


INSERT INTO tmp_RENDRE (CODE_BARRE,IDUTILISATEUR)
SELECT CODE_BARRE,IDUTILISATEUR
FROM RENDRE;

DROP TABLE IF EXISTS RENDRE;


RENAME tmp_RENDRE TO RENDRE;
ALTER TABLE RENDRE
ADD
 PRIMARY KEY (CODE_BARRE) ;

ALTER TABLE EMPRUNTER
   DROP FOREIGN KEY FK_EMPRUNTER_EXEMPLAIRE;

# -----------------------------------------------------------------------------
#       TABLE : tmp_EMPRUNTER
# -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS tmp_EMPRUNTER
 (
   CODE_BARRE CHAR(32) NOT NULL  ,
   IDUTILISATEUR REAL(5,2) NULL  ,
   DATE_PRET CHAR(32) NULL  
 ) 
 comment = "";


INSERT INTO tmp_EMPRUNTER (CODE_BARRE,IDUTILISATEUR)
SELECT CODE_BARRE,IDUTILISATEUR
FROM EMPRUNTER;

DROP TABLE IF EXISTS EMPRUNTER;


RENAME tmp_EMPRUNTER TO EMPRUNTER;
ALTER TABLE EMPRUNTER
ADD
 PRIMARY KEY (CODE_BARRE) ;


# -----------------------------------------------------------------------------
#       CREATION DES REFERENCES DE TABLE
# -----------------------------------------------------------------------------

ALTER TABLE EXEMPLAIRE
   DROP FOREIGN KEY FK_EXEMPLAIRE_RESSOURCE;


ALTER TABLE ETUDIANT 
  ADD FOREIGN KEY FK_ETUDIANT_UTILISATEUR (IDUTILISATEUR)
      REFERENCES UTILISATEUR (IDUTILISATEUR) ;


ALTER TABLE RESSOURCE 
  ADD FOREIGN KEY FK_RESSOURCE_EMPLACEMENT (ZONE)
      REFERENCES EMPLACEMENT (ZONE) ;


ALTER TABLE PARTICULIER 
  ADD FOREIGN KEY FK_PARTICULIER_UTILISATEUR (IDUTILISATEUR)
      REFERENCES UTILISATEUR (IDUTILISATEUR) ;


ALTER TABLE ENREGISTRE 
  ADD FOREIGN KEY FK_ENREGISTRE_UTILISATEUR (IDUTILISATEUR)
      REFERENCES UTILISATEUR (IDUTILISATEUR) ;


ALTER TABLE ENREGISTRE 
  ADD FOREIGN KEY FK_ENREGISTRE_BIBLIOTHECAIRE (CODE)
      REFERENCES BIBLIOTHECAIRE (CODE) ;


ALTER TABLE POSSEDER 
  ADD FOREIGN KEY FK_POSSEDER_RESSOURCE (IDRES)
      REFERENCES RESSOURCE (IDRES) ;


ALTER TABLE POSSEDER 
  ADD FOREIGN KEY FK_POSSEDER_EXEMPLAIRE (CODE_BARRE)
      REFERENCES EXEMPLAIRE (CODE_BARRE) ;


ALTER TABLE RENDRE 
  ADD FOREIGN KEY FK_RENDRE_EXEMPLAIRE (CODE_BARRE)
      REFERENCES EXEMPLAIRE (CODE_BARRE) ;


ALTER TABLE RENDRE 
  ADD FOREIGN KEY FK_RENDRE_UTILISATEUR (IDUTILISATEUR)
      REFERENCES UTILISATEUR (IDUTILISATEUR) ;


ALTER TABLE EMPRUNTER 
  ADD FOREIGN KEY FK_EMPRUNTER_EXEMPLAIRE (CODE_BARRE)
      REFERENCES EXEMPLAIRE (CODE_BARRE) ;


ALTER TABLE EMPRUNTER 
  ADD FOREIGN KEY FK_EMPRUNTER_UTILISATEUR (IDUTILISATEUR)
      REFERENCES UTILISATEUR (IDUTILISATEUR) ;

